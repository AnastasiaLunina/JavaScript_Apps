import check from 'check-types'
import {debug} from 'zog'
import _ from 'lodash'

// serviceHub - A LiveServiceHub instance.
// services - Dictionary of service names to consume and provide.
//   {consume, provide}
// module - Service names from the `services` dict correspond to function names
//   on this object.
export default function({serviceHub, services, module, modulePath}) {

  if (!services) return

  // TODO(vjpr): `this` is not working inside named functions. WTF.
  //   Maybe a old buggy babel version.

  const consumers = (obj) => {
    for (const keyPath in obj) {
      const versionToFnName = obj[keyPath]
      for (const version in versionToFnName) {
        const fnNameOrFn = versionToFnName[version]
        let consumerCallback = _.isFunction(fnNameOrFn) ? fnNameOrFn : module[fnNameOrFn]
        if (!consumerCallback) {
          throw new Error(`Consumer callback method '${fnNameOrFn}' not found on module '${modulePath}'. Using version dict: ${JSON.stringify(versionToFnName)}.`)
        }
        consumerCallback = consumerCallback.bind(module)
        // TODO(vjpr): Instrument consumerCallback for logging.
        serviceHub.consume(keyPath, version, consumerCallback)
      }
    }
  }

  const providers = (obj) => {
    for (const keyPath in obj) {
      const versionToFnName = obj[keyPath]
      check.object(versionToFnName)
      for (const version in versionToFnName) {
        const fnNameOrFn = versionToFnName[version]
        let serviceGetter = _.isFunction(fnNameOrFn) ? fnNameOrFn : module[fnNameOrFn]
        // TODO(vjpr): Check if they made a mistake by not passing in an object (if they left out version from a provide).
        //   General validation needed.
        if (!serviceGetter) {
          throw new Error(`Service getter method '${fnNameOrFn}' not found on module '${modulePath}'. Using version dict: ${JSON.stringify(versionToFnName)}.`)
        }
        serviceGetter = serviceGetter.bind(module)
        debug('Initializing provider service', keyPath, version)
        let service = serviceGetter()
        if (!service) {
          throw new Error(`Service getter method '${fnNameOrFn}' on module '${modulePath}' did not return anything. Using version dict: ${JSON.stringify(versionToFnName)}.`)
        }
        serviceHub.provide(keyPath, version, service)
      }
    }
  }

  if (services.consume) consumers(services.consume)
  if (services.provide) providers(services.provide)

}
